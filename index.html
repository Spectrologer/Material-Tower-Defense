<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Basic setup for the webpage -->
    <meta charset="UTF-8">
    <!-- This makes sure the game looks good on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Iconic Tower Defense</title>

    <!-- This adds a favicon to the webpage, using a Google Material Icon -->
    <link rel="icon" href="images/rook.svg">
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">

    <!-- This script brings in TailwindCSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- These lines are for loading custom fonts from Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- This is the main font used for the game's text -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <!-- These are for the icons used throughout the game (like for towers and buttons) -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <!-- Adding Font Awesome for the new Cat Tower icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />


    <!-- This is where we define the game's custom styles -->
    <style>
        /* General look and feel for the whole page */
        body,
        html {
            font-family: 'Montserrat', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0d0d0d 100%);
            color: #f5f5f5;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            overflow: hidden;
            height: 100%;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* New rule to change cursor when dragging */
        body.is-dragging {
            cursor: grabbing !important;
        }

        /* Style for the game's drawing area (the canvas) */
        canvas {
            background: linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 50%, #1a1a1a 100%);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 8px 32px rgba(0, 0, 0, 0.6),
                0 4px 16px rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.15);
            position: absolute;
            cursor: grab;
        }

        /* Style for all the UI panels (stats, towers, game over screen) */
        .game-ui-panel,
        .game-over-modal,
        .game-stats-panel {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px) saturate(1.8);
            -webkit-backdrop-filter: blur(20px) saturate(1.8);
            border-radius: 16px;
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.05),
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 4px 16px rgba(0, 0, 0, 0.2);
        }

        /* Style for the clickable buttons */
        .pixel-button {
            background: rgba(0, 0, 0, 0.3);
            color: #f5f5f5;
            font-weight: 900;
            /* Bolder text */
            text-shadow: none;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 14px 15px;
            font-size: 1.2rem;
            /* Even larger font size */
            /* Larger font size */
            letter-spacing: 1px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 4px 0 rgba(0, 0, 0, 0.4),
                0 6px 12px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }

        .pixel-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    transparent,
                    rgba(255, 255, 255, 0.1),
                    transparent);
            transition: left 0.5s ease;
        }

        /* What buttons look like when you hover over them */
        .pixel-button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.15),
                0 6px 0 rgba(0, 0, 0, 0.4),
                0 8px 16px rgba(0, 0, 0, 0.4);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .pixel-button:hover:not(:disabled)::before {
            left: 100%;
        }

        /* What buttons look like when you're clicking them */
        .pixel-button:active:not(:disabled) {
            transform: translateY(2px);
            /* Move down a bit more */
            box-shadow:
                inset 0 1px 0 rgba(0, 0, 0, 0.2),
                /* Darker inset shadow */
                0 1px 0 rgba(0, 0, 0, 0.4),
                /* Much smaller bottom shadow */
                0 2px 4px rgba(0, 0, 0, 0.3);
            /* Smaller overall shadow */
            background: rgba(0, 0, 0, 0.1);
            /* Slightly darker background */
        }

        /* Style for programmatically depressed buttons */
        .pixel-button.depressed {
            transform: translateY(2px);
            box-shadow:
                inset 0 1px 0 rgba(0, 0, 0, 0.2),
                0 1px 0 rgba(0, 0, 0, 0.4),
                0 2px 4px rgba(0, 0, 0, 0.3);
            background: rgba(0, 0, 0, 0.1);
        }

        /* Style for buttons you can't afford or use yet */
        .pixel-button:disabled {
            background: rgba(255, 255, 255, 0.05);
            color: #888;
            text-shadow: none;
            border-color: rgba(255, 255, 255, 0.08);
            box-shadow:
                inset 0 1px 0 rgba(255, 255, 255, 0.03),
                0 2px 0 rgba(0, 0, 0, 0.2),
                0 3px 6px rgba(0, 0, 0, 0.2);
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* Highlights the tower button you've selected to place */
        .tower-button.selected,
        #cloud-inventory-slots .pixel-button.selected {
            background-color: #ffffff;
            color: #111;
            border-color: #ffffff;
            box-shadow: 0 4px 0px 0px #8b5cf6, 0 0 12px #c084fc;
            /* Changed glow to purple */
            transform: translateY(0);
        }

        /* Specific styles for the tower buttons to give them color-coded tints */
        #buy-pin {
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 6px 0 #b3b3b3, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        #buy-castle {
            box-shadow: inset 0 1px 0 rgba(255, 153, 0, 0.1),
                0 6px 0 #9a6800, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 153, 0, 0.3);
            background: rgba(255, 153, 0, 0.05);
        }

        #buy-support {
            box-shadow: inset 0 1px 0 rgba(248, 112, 255, 0.1),
                0 6px 0 #b91c1c, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(248, 112, 255, 0.3);
            background: rgba(248, 112, 255, 0.05);
        }

        #start-wave {
            box-shadow: inset 0 1px 0 rgba(74, 222, 128, 0.1), 0 6px 0 #16a34a, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(74, 222, 128, 0.3);
            background: rgba(74, 222, 128, 0.05);
        }

        #speed-toggle {
            box-shadow: inset 0 1px 0 rgba(96, 165, 250, 0.1), 0 6px 0 #2563eb, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(96, 165, 250, 0.3);
            background: rgba(96, 165, 250, 0.05);
        }

        #cloud-button {
            box-shadow: inset 0 1px 0 rgba(209, 213, 219, 0.1), 0 6px 0 #9ca3af, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(209, 213, 219, 0.3);
            background: rgba(209, 213, 219, 0.05);
        }

        #cloud-button.active {
            box-shadow: inset 0 1px 0 rgba(56, 189, 248, 0.1), 0 6px 0 #0284c7, 0 8px 16px rgba(0, 0, 0, 0.3);
            border-color: rgba(96, 165, 250, 0.5);
            background: rgba(96, 165, 250, 0.2);
        }

        #cloud-button.active #cloud-icon {
            font-size: 2rem !important;
            /* 32px */
            color: #93c5fd;
            /* A light blue color */
        }

        #set-ground-target-btn.active {
            background-color: #f59e0b;
            border-color: #fde047;
            color: #1a1a1a;
            box-shadow: 0 4px 0 #b45309;
        }

        /* FIX: Explicitly set font-family for icon classes to override global font and fix tooltips. */
        .material-icons {
            font-family: 'Material Icons';
        }

        .material-symbols-outlined {
            font-family: 'Material Symbols Outlined';
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 48;
        }

        .fa-solid {
            font-family: "Font Awesome 6 Free";
            font-weight: 900;
        }

        /* Custom styles for the new debug button */
        #infinite-gold {
            background-color: rgba(220, 38, 38, 0.7);
            /* Red with transparency */
            border-color: rgba(220, 38, 38, 0.9);
            /* Red with transparency */
            color: #fde047;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #infinite-gold:hover:not(:disabled) {
            background-color: rgba(239, 68, 68, 0.8);
            /* Lighter red on hover */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        }

        #infinite-gold:active:not(:disabled) {
            transform: translateY(1px);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Custom tooltip styling */
        .tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            /* Slightly more transparent tooltip */
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.5);
            /* Softer green border */
            padding: 8px 8px 16px;
            font-size: 14px;
            font-family: 'Roboto', 'Open Sans';
            text-align: center;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            /* Prevents the tooltip from blocking mouse events */
            border-radius: 5px;
        }

        .bottom-controls {
            background-color: rgba(255, 255, 255, 0.15);
            /* Lighter, more translucent background */
            backdrop-filter: blur(10px);
            /* Stronger blur effect */
            border: 1px solid rgba(255, 255, 255, 0.3);
            /* Subtle white border for glass effect */
            padding: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: space-between;
            border-radius: 10px;
            /* Softer corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* Subtle shadow for depth */
        }

        .options-menu {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 29;
            width: 200px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .options-menu.hidden {
            display: none;
        }

        /* A visual indicator for the selected maze color button */
        .color-option.selected {
            border-color: #00ff88;
            box-shadow: 0 0 8px #00ff88;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            transition: .4s;
            border: 2px solid #888;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 12px;
            width: 12px;
            left: 2px;
            bottom: 2px;
            background-color: #e0e0e0;
            transition: .4s;
        }

        input:checked+.slider {
            background-color: #c084fc;
            border-color: #a855f7;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
            background-color: #1a1a1a;
        }

        .toggle-btn:disabled {
            opacity: 0.3;
        }

        /* FIX: Prevents icons inside buttons from capturing click events. */
        .pixel-button span,
        .pixel-button i {
            pointer-events: none;
        }
    </style>

</head>

<body class="flex items-center justify-center">

    <!-- This is the main container for the entire game interface. -->
    <div class="flex flex-col h-full w-full items-center p-2 sm:p-4 gap-2">

        <!-- This is the stats bar at the top (Lives, Gold, Wave) and options button -->
        <div class="game-stats-panel py-1 px-2 flex-shrink-0 w-full max-w-[440px] flex flex-col gap-y-1">
            <h1 class="text-xl sm:text-2xl text-fuchsia-400 text-center">ICONIC DEFENSE</h1>
            <div class="grid grid-cols-[auto_1fr_auto] items-center">
                <div class="justify-self-start">
                    <button id="options-btn" class="pixel-button !p-0 w-10 h-10 flex items-center justify-center">
                        <span class="material-symbols-outlined !text-2xl">settings</span>
                    </button>
                </div>
                <div class="grid grid-cols-3 gap-x-2 md:gap-x-4 place-items-center text-sm md:text-base">
                    <p class="flex items-center gap-1.5"><span
                            class="material-symbols-outlined text-red-500 text-lg md:text-xl">favorite</span> <span
                            id="lives" class="text-red-500">20</span></p>
                    <p class="flex items-center gap-1.5"><span
                            class="material-symbols-outlined text-yellow-400 text-lg md:text-xl">paid</span> <span
                            id="gold" class="text-yellow-400">100</span></p>
                    <p class="flex items-center gap-1 text-cyan-400">WAVE: <span id="wave"
                            class="text-cyan-400">0</span></p>
                </div>
                <div class="flex justify-self-end">
                    <!-- Container for the sound toggle button -->
                    <button id="music-toggle-btn" class="text-xs px-2 py-1 toggle-btn">
                        <span id="music-icon" class="material-icons">music_off</span>
                    </button>
                    <button id="sound-toggle-btn" class="text-xs px-2 py-1 toggle-btn">
                        <span id="sound-icon" class="material-icons">volume_up</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Options Menu -->
        <div id="options-menu-overlay" class="hidden fixed inset-0 z-25 bg-black/50"></div> <!-- New overlay -->
        <div id="options-menu" class="options-menu game-ui-panel hidden">
            <h3 class="text-lg text-fuchsia-400 mb-2">OPTIONS</h3>
            <button id="library-btn"
                class="pixel-button text-sm py-2 text-center grid grid-cols-[24px_1fr] items-center gap-2 mt-2 shadow-[0_4px_0_#4b5563] border-gray-400">
                <span class="material-symbols-outlined !text-lg justify-self-center"
                    style="color: #81d4fa;">menu_book</span>
                <span class="text-left">LIBRARY</span>
            </button>
            <button id="trophies-btn"
                class="pixel-button text-sm py-2 text-center grid grid-cols-[24px_1fr] items-center gap-2 shadow-[0_4px_0_#4b5563] border-gray-400">
                <span class="material-symbols-outlined !text-lg justify-self-center"
                    style="color: #ffd700;">emoji_events</span>
                <span class="text-left">TROPHIES</span>
            </button>
            <button id="log-btn"
                class="pixel-button text-sm py-2 text-center grid grid-cols-[24px_1fr] items-center gap-2 shadow-[0_4px_0_#4b5563] border-gray-400">
                <span class="material-symbols-outlined !text-lg justify-self-center"
                    style="color: #a5d6a7;">history_edu</span>
                <span class="text-left">MESSAGE LOG</span>
            </button>
            <button id="toggle-merge-confirm-btn" class="pixel-button text-sm py-2 text-center mt-2">CONFIRM MERGES:
                ON</button>
            <button id="reset-game-btn"
                class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c] text-sm py-2 text-center mt-2">RESET
                GAME</button>
            <div class="flex gap-2 mt-auto pt-2">
                <div class="relative w-1/2">
                    <button id="changelog-btn"
                        class="pixel-button text-sm py-2 text-center w-full flex items-center justify-center">
                        <span class="material-symbols-outlined align-middle !text-lg"
                            style="color: #b39ddb;">history</span>
                    </button>
                    <span id="changelog-indicator"
                        class="hidden absolute top-0 right-0 -mt-1 -mr-1 px-2 py-1 bg-red-600 text-white text-[8px] font-bold rounded-full">NEW</span>
                </div>
                <a href="https://github.com/Spectrologer" target="_blank"
                    class="pixel-button !p-0 w-1/2 flex items-center justify-center bg-gray-800 border-gray-600 shadow-[0_4px_0_#4b5563]">
                    <i class="fa-brands fa-github !text-2xl"></i>
                </a>
            </div>
        </div>


        <!-- This container holds the actual game canvas AND the new cloud inventory -->
        <div class="flex-grow relative w-full max-w-[440px] min-h-0 flex gap-2">
            <div id="canvas-container" class="flex-grow relative h-full min-h-0">
                <button id="delete-btn"
                    class="pixel-button !p-0 w-12 h-12 hidden absolute bottom-2 right-2 bg-red-700 border-red-500 shadow-[0_4px_0_#b91c1c] flex items-center justify-center z-10">
                    <span class="material-symbols-outlined !text-2xl">ink_eraser</span>
                </button>
                <!-- The canvas is now draggable to enable dragging towers from the game grid -->
                <canvas id="gameCanvas" draggable="true"></canvas>
            </div>
            <!-- Cloud Inventory Panel, this is a drop target for towers from the canvas -->
            <div id="cloud-inventory-panel"
                class="hidden game-ui-panel w-[72px] flex-shrink-0 flex flex-col items-center p-1 gap-2 overflow-y-auto">
                <h3 class="text-xs text-fuchsia-400 -mb-1">CLOUD</h3>
                <div id="cloud-inventory-slots" class="flex flex-col gap-2 w-full items-center">
                    <!-- Inventoried towers will be added here -->
                </div>
            </div>
        </div>

        <!-- This is the control panel at the bottom of the screen -->
        <div class="game-ui-panel p-2 sm:p-4 w-full max-w-[440px] flex-shrink-0 flex flex-col gap-4 relative">

            <div id="onboarding-merge-tip"
                class="hidden absolute bottom-full mb-2 left-1/2 -translate-x-1/2 w-[90%] bg-sky-600 border-2 border-sky-400 p-2 text-center text-xs shadow-lg rounded-md z-10">
                <p class="text-white pr-4">Drag towers onto each other to merge and upgrade them!</p>
                <button id="onboarding-dismiss-btn" class="absolute top-0 right-0 p-1 text-white hover:text-sky-200">
                    <span class="material-symbols-outlined !text-base">close</span>
                </button>
            </div>

            <div id="tower-buttons-group" class="relative">
                <h2 id="towers-title" class="text-lg sm:text-xl text-fuchsia-400 text-center">TOWERS</h2>
                <!-- Buttons to buy the different towers -->
                <div id="tower-buttons" class="grid grid-cols-3 gap-4 mt-2">
                    <button id="buy-pin"
                        class="pixel-button tower-button text-sm sm:text-lg flex items-center justify-center text-center h-12 sm:h-auto">PIN
                        (25G)</button>
                    <button id="buy-castle"
                        class="pixel-button tower-button text-sm sm:text-lg flex items-center justify-center text-center h-12 sm:h-auto">CASTLE
                        (75G)</button>
                    <button id="buy-support"
                        class="pixel-button tower-button text-sm sm:text-lg flex items-center justify-center text-center h-12 sm:h-auto">
                        SUPPORT (50G)
                    </button>
                </div>
            </div>

            <!-- This panel appears when you select a tower you've already placed -->
            <div id="sell-panel" class="hidden flex flex-col gap-2">
                <hr class="border-gray-600" />
                <div class="grid grid-cols-3 items-center">
                    <div class="flex justify-start">
                        <button id="set-ground-target-btn"
                            class="pixel-button !p-0 w-12 h-12 flex items-center justify-center hidden">
                            <span class="material-symbols-outlined">gps_fixed</span>
                        </button>
                    </div>
                    <div class="text-center">
                        <h3 class="text-xl sm:text-2xl text-fuchsia-400">SELECTED</h3>
                    </div>
                    <div class="flex justify-end">
                        <div id="tower-kill-count" class="flex items-center gap-1 text-sm text-gray-400 hidden">
                            <span class="material-symbols-outlined !text-lg">skull</span>
                            <span id="kill-count-value">0</span>
                        </div>
                    </div>
                </div>
                <h4 id="selected-tower-info" class="text-center text-yellow-400 text-lg sm:text-xl min-h-[1rem]"></h4>
                <!-- Shows the stats of the selected tower -->
                <div id="tower-stats-panel"
                    class="flex flex-wrap justify-center gap-x-4 sm:gap-x-5 gap-y-2 text-sm sm:text-lg mb-2">
                    <p id="stat-damage-p" class="flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Damage">bolt</span> Dmg: <span
                            id="stat-damage">0</span></p>
                    <p id="stat-range-p" class="flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Range">radar</span> Rng: <span
                            id="stat-range">0</span></p>
                    <p id="stat-speed-p" class="flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Attack Speed">speed</span> Spd: <span
                            id="stat-speed">0</span>/s</p>
                    <p id="stat-splash-p" class="flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Splash Radius">bubble_chart</span> Spl:
                        <span id="stat-splash">0</span>
                    </p>
                    <p id="stat-projectiles-p" class="flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom"
                            title="Projectiles">multiple_stop</span> Proj: <span id="stat-projectiles">0</span></p>
                    <p id="stat-boost-p" class="flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Boost">electric_bolt</span> Bst: <span
                            id="stat-boost">0</span>%</p>
                    <p id="stat-slow-p" class="flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom" title="Slow">hourglass_empty</span>
                        Slw: <span id="stat-slow">0</span>%</p>
                    <p id="stat-gold-p" class="hidden flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Gold Bonus">savings</span> Gld: +<span
                            id="stat-gold">0</span>%</p>
                    <p id="stat-burn-p" class="flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom"
                            title="Burn Damage">local_fire_department</span> Brn: <span id="stat-burn">0/s</span></p>
                    <p id="stat-frags-p" class="hidden flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Fragments">call_split</span> Frags:
                        <span id="stat-frags">0</span>
                    </p>
                    <p id="stat-pins-p" class="hidden flex items-center gap-1"><span
                            class="material-icons text-xl align-bottom" title="Radial Pins">push_pin</span> Pins:
                        <span id="stat-pins">0</span>
                    </p>
                    <p id="stat-jumps-p" class="hidden flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom"
                            title="Chain Jumps">electric_bolt</span> Jumps: <span id="stat-jumps">0</span>
                    </p>
                    <p id="stat-stun-p" class="hidden flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom" title="Stun Duration">bolt</span>
                        Stun: <span id="stat-stun">0</span>s
                    </p>
                    <p id="stat-armor-pen-p" class="hidden flex items-center gap-1"><span
                            class="material-symbols-outlined text-xl align-bottom"
                            title="Armor Penetration">shield_moon</span>
                        AP: <span id="stat-armor-pen">0</span>
                    </p>
                    <p id="stat-special-p" class="flex items-center gap-1 col-span-full justify-center"><span
                            class="material-symbols-outlined text-xl align-bottom"
                            title="Special Ability">star</span><span id="stat-special">None</span></p>
                </div>
                <div class="flex flex-col gap-2 mt-2">
                    <button id="toggle-mode"
                        class="pixel-button bg-purple-800 text-yellow-300 border-yellow-300 hidden">MODE:
                    </button>
                    <button id="toggle-orbit-direction-btn"
                        class="pixel-button bg-green-800 text-lime-300 border-lime-300 hidden">DIR:
                        CW</button>
                    <button id="toggle-targeting" class="pixel-button hidden">TARGET:</button>
                </div>
                <div id="selected-tower-actions" class="grid grid-cols-2 gap-2 mt-2">
                    <!-- Button to sell the selected tower -->
                    <button id="sell-tower-btn"
                        class="pixel-button bg-red-700 text-yellow-300 border-yellow-400 shadow-[0_4px_0_#9a3412] py-2">SELL</button>
                    <!-- Button to move the selected tower to the cloud -->
                    <button id="move-to-cloud-btn"
                        class="pixel-button bg-cyan-700 text-white border-cyan-500 shadow-[0_4px_0_#0e7490] py-2 hidden items-center justify-center gap-1 sm:flex">
                        <span class="material-symbols-outlined !text-base">cloud_upload</span>
                        <span class="hidden sm:inline ">MOVE</span>
                    </button>
                </div>
            </div>

            <!-- Buttons for starting the next wave, changing game speed, and the new debug button -->
            <div id="game-controls" class="flex gap-4">
                <button id="start-wave"
                    class="pixel-button flex-auto text-sm sm:text-lg flex items-center justify-center">START
                    WAVE
                </button>
                <button id="speed-toggle"
                    class="pixel-button flex-auto text-sm sm:text-lg flex items-center justify-center">x1</button>
                <button id="cloud-button" class="pixel-button flex-auto flex items-center justify-center text-sm">
                    <span id="cloud-icon" class="material-symbols-outlined !text-lg">cloud</span>
                    <span id="cloud-text" class="ml-1 text-sm sm:text-lg">(25G)</span>
                </button>
            </div>
        </div>

    </div>

    <!-- This is the "Game Over" screen. It's hidden until you lose. -->
    <div id="game-over-modal"
        class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-20">
        <div class="game-over-modal text-center p-8">
            <h2 id="game-over-title" class="text-4xl mb-4">GAME OVER</h2>
            <p id="game-over-message" class="text-xl mb-6">You survived 0 waves!</p>
            <button id="restart-game" class="pixel-button text-2xl">RESTART</button>
        </div>
    </div>

    <!-- Endless Mode Choice Modal -->
    <div id="endless-choice-modal"
        class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-20">
        <div class="game-over-modal text-center p-8">
            <h2 class="text-4xl mb-4 text-fuchsia-400">WAVES COMPLETE!</h2>
            <p class="text-xl mb-6">You've beaten all handcrafted waves. What's next?</p>
            <div class="flex gap-4">
                <button id="start-endless-btn"
                    class="pixel-button text-2xl bg-purple-700 border-purple-500 shadow-[0_4px_0_#6b21a8]">START
                    ENDLESS</button>
                <button id="restart-endless-btn"
                    class="pixel-button text-2xl flex items-center justify-center">RESTART</button>
            </div>
        </div>
    </div>

    <!-- Wave 16 Power Choice Modal -->
    <div id="wave-16-power-choice-modal"
        class="hidden absolute inset-0 bg-black bg-opacity-75 flex items-center justify-center z-20">
        <div class="game-over-modal text-center p-8">
            <h2 class="text-4xl mb-4 text-fuchsia-400">POWER UP!</h2>
            <p class="text-xl mb-6">You've reached Wave 16! Choose your power:</p>
            <div class="flex flex-row gap-4 w-full justify-center">
                <button id="delete-power-btn"
                    class="pixel-button text-lg bg-red-700 border-red-500 shadow-[0_4px_0_#b91c1c] flex flex-col items-center justify-center h-24 w-24">
                    <span class="material-symbols-outlined !text-3xl">ink_eraser</span>
                    <span class="text-sm">DELETE</span>
                </button>
                <button id="cloud-power-btn"
                    class="pixel-button text-lg bg-blue-700 border-blue-500 shadow-[0_4px_0_#1e40af] flex flex-col items-center justify-center h-24 w-24">
                    <span class="material-symbols-outlined !text-3xl">cloud_done</span>
                    <span class="text-sm">CLOUD</span>
                </button>
                <button id="lives-power-btn"
                    class="pixel-button text-lg bg-green-700 border-green-500 shadow-[0_4px_0_#15803d] flex flex-col items-center justify-center h-24 w-24">
                    <span class="material-symbols-outlined !text-3xl">heart_plus</span>
                    <span class="text-sm">+20 LIVES</span>
                </button>
            </div>
        </div>
    </div>


    <!-- New Merge Confirmation Modal -->
    <div id="merge-confirm-modal"
        class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-30">
        <div class="game-ui-panel text-center p-6 w-11/12 max-w-sm">
            <h3 class="text-lg sm:text-xl text-fuchsia-400 mb-4">CONFIRM MERGE</h3>
            <div class="flex items-center justify-center gap-4 text-white text-sm sm:text-base">
                <div id="merge-from-tower-icon-container" class="w-12 h-12 flex items-center justify-center text-3xl">
                </div>
                <span id="merge-from-tower-name" class="mt-1"></span>
            </div>
            <span class="material-symbols-outlined text-2xl text-yellow-400">add</span>
            <div class="flex flex-col items-center">
                <div id="merge-to-tower-icon-container" class="w-12 h-12 flex items-center justify-center text-3xl">
                </div>
                <span id="merge-to-tower-name" class="mt-1"></span>
            </div>
            <span class="material-symbols-outlined text-2xl text-fuchsia-400">arrow_right_alt</span>
            <div class="flex flex-col items-center">
                <div id="merge-result-tower-icon-container" class="w-12 h-12 flex items-center justify-center text-3xl">
                </div>
                <span id="merge-result-tower-name" class="mt-1"></span>
                <span id="merge-result-benefit-text" class="text-xs text-yellow-400 mt-1"></span>
            </div>
            <div id="merge-cost-info" class="text-center text-yellow-400 text-sm my-4"></div>
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button id="confirm-merge-btn"
                    class="pixel-button bg-purple-700 text-white border-purple-500 shadow-[0_4px_0_#6b21a8]">CONFIRM</button>
                <button id="cancel-merge-btn"
                    class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c]">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- Library Modal -->
    <div id="library-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40">
        <div class="game-ui-panel p-4 w-11/12 max-w-lg h-[85%] flex flex-col">
            <h3 class="text-lg sm:text-xl text-fuchsia-400 mb-2 text-center">LIBRARY</h3>
            <!-- Tabs -->
            <div class="flex border-b-2 border-gray-600 mb-2">
                <button id="library-towers-tab"
                    class="pixel-button flex-1 !rounded-b-none border-b-0 bg-gray-600 text-sm py-2">TOWERS</button>
                <button id="library-enemies-tab"
                    class="pixel-button flex-1 !rounded-b-none border-b-0 text-sm py-2">ENEMIES</button>
            </div>

            <!-- Rolodex Container -->
            <div class="flex-grow relative bg-black/20 p-2 border border-gray-600 overflow-hidden min-h-0">
                <div id="tower-library-rolodex" class="w-full h-full">
                    <!-- Tower Cards will be generated here -->
                </div>
                <div id="enemy-library-rolodex" class="w-full h-full hidden">
                    <!-- Enemy Cards will be generated here -->
                </div>
            </div>

            <div class="flex justify-between items-center mt-4">
                <button id="library-prev-btn" class="pixel-button text-base p-2">&lt; PREV</button>
                <span id="library-counter" class="text-white text-base">1 / X</span>
                <button id="library-next-btn" class="pixel-button text-base p-2">NEXT &gt;</button>
            </div>
            <button id="library-close-btn"
                class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c] mt-4">CLOSE</button>
        </div>
    </div>

    <!-- Trophies Modal -->
    <div id="trophies-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40">
        <div class="game-ui-panel p-4 w-11/12 max-w-sm h-3/4 flex flex-col">
            <h3 class="text-lg sm:text-xl text-fuchsia-400 mb-4 text-center">TROPHIES</h3>
            <div id="trophies-list" class="flex-grow bg-black/20 p-2 border border-gray-600 overflow-y-auto">
                <!-- Trophy items will be generated here -->
            </div>
            <button id="trophies-close-btn"
                class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c] mt-4">CLOSE</button>
        </div>
    </div>

    <!-- Changelog Modal -->
    <div id="changelog-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40">
        <div class="game-ui-panel p-4 w-11/12 max-w-sm h-3/4 flex flex-col">
            <h3 class="text-lg sm:text-xl text-fuchsia-400 mb-4 text-center">CHANGELOG</h3>
            <div id="changelog-list"
                class="flex-grow bg-black/20 p-2 border border-gray-600 overflow-y-auto flex flex-col gap-4">
                <!-- Changelog items will be generated here -->
            </div>
            <button id="changelog-close-btn"
                class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c] mt-4">CLOSE</button>
        </div>
    </div>

    <!-- Message Log Modal -->
    <div id="log-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-40">
        <div class="game-ui-panel p-4 w-11/12 max-w-sm h-3/4 flex flex-col">
            <h3 class="text-lg sm:text-xl text-fuchsia-400 mb-4 text-center">MESSAGE LOG</h3>
            <div id="log-list"
                class="flex-grow bg-black/20 p-2 border border-gray-600 overflow-y-auto flex flex-col-reverse gap-2">
                <!-- Log items will be generated here -->
            </div>
            <button id="log-close-btn"
                class="pixel-button bg-red-700 text-white border-red-500 shadow-[0_4px_0_#b91c1c] mt-4">CLOSE</button>
        </div>
    </div>

    <script type="module" src="js/main.js"></script>

</body>

</html>